{% extends "base.html" %}

{% block title %}–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ –æ–∫—Ç—è–±—Ä—å 2025{% endblock %}

{% block content %}

{% from 'macros/macros.html' import legend_values %}

<h1 class="text-2xl font-bold mb-6 text-center">–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ –æ–∫—Ç—è–±—Ä—å 2025</h1>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filter-section mb-6">
    <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
    <table>
        <tr>
            <th><label>–ö–°–ü</label><input type="text" id="filter-ksp"></th>
            <th><label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ö–°–ü</label><input type="text" id="filter-name"></th>
            <th><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><input type="text" id="filter-category"></th>
        </tr>
    </table>
    <table>
        <tr>
            <th><label>–ü—Ä–æ—Ñ–µ—Å—Å–∏—è</label><input type="text" id="filter-profession"></th>
            <th><label>–°—Ç–∞—Ç—É—Å</label><input type="text" id="filter-status"></th>
            <th><label>–¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä</label><input type="text" id="filter-service-number"></th>
        </tr>
    </table>
    <div style="margin-top: 10px;">
        <label>–§–∞–º–∏–ª–∏—è</label>
        <input type="text" id="filter-surname"
               style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
    </div>
</div>

<br>

<!-- –ì–ª–∞–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
<div class="table-report-card">
    <table>
        <thead>
        <tr>
            <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ö–°–ü</th>
            <th>–ü—Ä–æ—Ñ–µ—Å—Å–∏—è</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–¢–∞–± ‚Ññ</th>
            <th>–§.–ò.–û.</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>
            <th>8</th>
            <th>9</th>
            <th>10</th>
            <th>11</th>
            <th>12</th>
            <th>13</th>
            <th>14</th>
            <th>15</th>
            <th>16</th>
            <th>17</th>
            <th>18</th>
            <th>19</th>
            <th>20</th>
            <th>21</th>
            <th>22</th>
            <th>23</th>
            <th>24</th>
            <th>25</th>
            <th>26</th>
            <th>27</th>
            <th>28</th>
            <th>29</th>
            <th>30</th>
            <th>31</th>
        </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>
</div>

{{ legend_values() }}
<!--&lt;!&ndash; –õ–µ–≥–µ–Ω–¥–∞ –∑–Ω–∞—á–µ–Ω–∏–π &ndash;&gt;-->
<!--<div class="legend-container">-->
<!--    <h2>–õ–µ–≥–µ–Ω–¥–∞ –∑–Ω–∞—á–µ–Ω–∏–π</h2>-->
<!--    <div class="legend-grid">-->
<!--        <div class="legend-item">-->
<!--            <div class="legend-color red"></div>-->
<!--            –ë - –ë–æ–ª—å–Ω–∏—á–Ω—ã–π-->
<!--        </div>-->
<!--        <div class="legend-item">-->
<!--            <div class="legend-color blue"></div>-->
<!--            –û - –û—Ç–ø—É—Å–∫-->
<!--        </div>-->
<!--        <div class="legend-item">-->
<!--            <div class="legend-color green"></div>-->
<!--            1 - –†–∞–±–æ—á–∏–π –¥–µ–Ω—å-->
<!--        </div>-->
<!--        <div class="legend-item">-->
<!--            <div class="legend-color amber"></div>-->
<!--            –ü–° - –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è-->
<!--        </div>-->
<!--        <div class="legend-item">-->
<!--            <div class="legend-color purple"></div>-->
<!--            –î–û - –î–µ–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–ø—É—Å–∫-->
<!--        </div>-->
<!--        <div class="legend-item">-->
<!--            <div class="legend-color indigo"></div>-->
<!--            –ë–î - –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–µ–Ω—å-->
<!--        </div>-->
<!--        <div class="legend-item">-->
<!--            <div class="legend-color cyan"></div>-->
<!--            –ì - –°–ª—É–∂–∏—Ç-->
<!--        </div>-->
<!--        <div class="legend-item">-->
<!--            <div class="legend-color yellow"></div>-->
<!--            –í - –í—ã—Ö–æ–¥–Ω–æ–π-->
<!--        </div>-->
<!--        <div class="legend-item">-->
<!--            <div class="legend-color gray"></div>-->
<!--            - - –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

{% endblock %}

<!-- –í—ã–±–æ—Ä –¥–∞—Ç—ã –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ –ø–æ–¥—Å—á—ë—Ç–∞ -->
<div class="sort-section mb-6">
    <br>
    <label for="sort-date" class="sort-date">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–¥—Å—á–∏—Ç–∞—Ç—å –ø–æ –¥–∞—Ç–µ:</label>
    <select id="sort-date">
        <option value="">–ù–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</option>
        {% for day in range(1, 32) %}
        <option value="{{ day }}">{{ day }}</option>
        {% endfor %}
    </select>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ª–µ–≥–µ–Ω–¥–µ -->
<div class="stats-section mb-6">
    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç–µ</h2>
    <div id="stats-output" class="grid grid-cols-3 gap-2 text-sm">
        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
    </div>
</div>

{% block scripts %}

<script>
    let data = [];
    let currentSortDate = null; // —Ç–µ–∫—É—â–∞—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

    // –ö–∞—Ä—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ª–µ–≥–µ–Ω–¥—ã ‚Üí —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
    const legendMap = {
        '–ë': '–ë–æ–ª—å–Ω–∏—á–Ω—ã–π',
        '–û': '–û—Ç–ø—É—Å–∫',
        '1': '–†–∞–±–æ—á–∏–π –¥–µ–Ω—å',
        '–ü–°': '–ü—Ä–æ—Å—Ç–æ–π',
        '–î–û': '–î–µ–∫—Ä–µ—Ç',
        '–ë–î': '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–µ–Ω—å',
        '–ì': '–°–ª—É–∂–∏—Ç',
        '–í': '–í—ã—Ö–æ–¥–Ω–æ–π',
        '–≤': '–í—ã—Ö–æ–¥–Ω–æ–π',
        '-': '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç'
    };

    // üëá –î–û–ë–ê–í–õ–ï–ù–û: –∫–∞–∫–∏–µ —Å—Ç–∞—Ç—É—Å—ã –≤—Ö–æ–¥—è—Ç –≤ —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å
    const countedStatuses = new Set(['1', '–ì', '–ü–°', '–î–û', '–û', '–í', '–≤']);

    // –ü–æ–ª—É—á–∏—Ç—å —Ü–≤–µ—Ç —è—á–µ–π–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–∏—è
    function getCellColor(value) {
        switch (value) {
            case '–ë':
                return 'bg-red-100 text-red-800 border border-red-300';
            case '–û':
                return 'bg-blue-100 text-blue-800 border border-blue-300';
            case '1':
                return 'bg-green-100 text-green-800 border border-green-300';
            case '–ü–°':
                return 'bg-amber-100 text-amber-800 border border-amber-300';
            case '–î–û':
                return 'bg-purple-100 text-purple-800 border border-purple-300';
            case '–ë–î':
                return 'bg-indigo-100 text-indigo-800 border border-indigo-300';
            case '–ì':
                return 'bg-cyan-100 text-cyan-800 border border-cyan-300';
            case '–í':
                return 'bg-yellow-100 text-yellow-800 border border-yellow-300';
            case '–≤':
                return 'bg-yellow-100 text-yellow-800 border border-yellow-300';
            case '-':
                return 'bg-gray-100 text-gray-800 border border-gray-300';
            default:
                return 'bg-white text-black border border-gray-200';
        }
    }

    // –ü–æ–¥—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –¥–∞—Ç–µ (–∏–Ω–¥–µ–∫—Å = dayIndex, –æ—Ç 0 –¥–æ 30)
    function calculateStats(dayIndex) {
        const stats = {};
        let totalCount = 0; // –æ–±—â–∞—è —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—é

        data.forEach(row => {
            const val = row.days[dayIndex] || '-';
            stats[val] = (stats[val] || 0) + 1;
            if (countedStatuses.has(val)) {
                totalCount++;
            }
        });
        return { stats, totalCount }; // üëà –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function renderStats(dayIndex) {
        const statsContainer = document.getElementById('stats-output');
        if (dayIndex === null) {
            statsContainer.innerHTML = '<p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>';
            return;
        }

        const result = calculateStats(dayIndex);
        const stats = result.stats;
        const totalCount = result.totalCount;

        let html = '';

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏
        for (const [key, count] of Object.entries(stats)) {
            const label = legendMap[key] || key;
            html += `<div><strong>${key}</strong>: ${label} ‚Äî ${count} —à—Ç.</div>`;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â—É—é —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å
        html += `<div class="col-span-3 mt-2 font-bold">–û–±—â–∞—è —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å: ${totalCount} —á–µ–ª.</div>`;

        statsContainer.innerHTML = html || '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
    }

    // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–∞—Ç–µ
    function compareByDate(a, b, dayIndex) {
        const valA = a.days[dayIndex] || '';
        const valB = b.days[dayIndex] || '';

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –∏–ª–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
        if (valA < valB) return -1;
        if (valA > valB) return 1;
        return 0;
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã
    function renderTable() {
        const tbody = document.getElementById('table-body');
        const filterKsp = document.getElementById('filter-ksp').value;
        const filterName = document.getElementById('filter-name').value;
        const filterCategory = document.getElementById('filter-category').value;
        const filterProfession = document.getElementById('filter-profession').value;
        const filterStatus = document.getElementById('filter-status').value;
        const filterServiceNumber = document.getElementById('filter-service-number').value;
        const filterSurname = document.getElementById('filter-surname').value;

        const filteredData = data.filter(row => {
            return (
            (!filterKsp || row.–ö–°–ü.includes(filterKsp)) &&
            (!filterName || row.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ.toLowerCase().includes(filterName.toLowerCase())) &&
            (!filterCategory || row.–ö–∞—Ç–µ–≥–æ—Ä–∏—è.toLowerCase().includes(filterCategory.toLowerCase())) &&
            (!filterProfession || row.–ü—Ä–æ—Ñ–µ—Å—Å–∏—è.toLowerCase().includes(filterProfession.toLowerCase())) &&
            (!filterStatus || row.–°—Ç–∞—Ç—É—Å.toLowerCase().includes(filterStatus.toLowerCase())) &&
            (!filterServiceNumber || row.–¢–∞–±.includes(filterServiceNumber)) &&
            (!filterSurname || row.–§–ò–û.toLowerCase().includes(filterSurname.toLowerCase()))
            );
        });

        tbody.innerHTML = '';

        filteredData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ}</td>
                <td>${row.–ü—Ä–æ—Ñ–µ—Å—Å–∏—è}</td>
                <td>${row.–°—Ç–∞—Ç—É—Å}</td>
                <td>${row.–¢–∞–±}</td>
                <td>${row.–§–ò–û}</td>
            `;

            row.days.forEach(day => {
                const td = document.createElement('td');
                td.className = `w-2 py-2 whitespace-nowrap text-sm ${getCellColor(day)} text-center`;
                td.textContent = day;
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
        try {
            const response = await fetch("/data_10");
            if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
            data = await response.json();
            renderTable();
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:", error);
            document.getElementById('table-body').innerHTML = `
                <tr><td colspan="36" class="text-center py-4 text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>
            `;
        }
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    document.getElementById('filter-ksp').oninput = renderTable;
    document.getElementById('filter-name').oninput = renderTable;
    document.getElementById('filter-category').oninput = renderTable;
    document.getElementById('filter-profession').oninput = renderTable;
    document.getElementById('filter-status').oninput = renderTable;
    document.getElementById('filter-service-number').oninput = renderTable;
    document.getElementById('filter-surname').oninput = renderTable;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadData();
</script>

{% endblock %}